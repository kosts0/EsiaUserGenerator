@page "/status/{RequestId}"
@using System.Text.Json
@using EsiaUserMfe.Dto
@using EsiaUserMfe.Service.Interface
@using MudBlazor
@inject IApiClient ApiClient
@inject ISnackbar Snackbar

<MudPaper Class="p-6 mt-4 mx-auto" Style="max-width:700px">

    <MudText Typo="Typo.h4" Class="mb-2">Статус обработки</MudText>

    @if (IsLoading)
    {
        <div class="d-flex justify-center my-5">
            <MudProgressCircular Size="Size.Large" Indeterminate Color="Color.Primary" />
        </div>
    }
    @if (Status == null)
    {
        <MudAlert Severity="Severity.Error">Заявка не найдена</MudAlert>
    }
    else
    {
        <!-- Линия статуса -->
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.h6">Текущий статус:</MudText>
            <MudChip T="StatusResponse" Color="@ChipColor" Variant="Variant.Filled">
                @Status.Data.CurrentStatus
            </MudChip>
        </MudStack>

        <MudDivider Class="my-4" />

        <!-- Общая информация -->
        <MudText Typo="Typo.h6">Информация о заявке</MudText>
        <table class="mud-table-root mud-elevation-0" style="width:100%">
            <tr><td><b>Код</b></td><td>@Status.Code (@Status.CodeStatus)</td></tr>
        </table>

        <MudDivider Class="my-4" />

        <!-- JSON generatedData -->
        <MudText Typo="Typo.h6">GeneratedData (JSON)</MudText>

        <MudTextField Value="@GeneratedJson"
                      ValueChanged="OnJsonEditAttempt"
                      Lines="12"
                      FullWidth="true"
                      Variant="Variant.Outlined" />

    }
</MudPaper>

@code {
    [Parameter] public string? RequestId { get; set; }

    private StatusResponse? Status;
    private bool IsLoading = true;
    private Timer? PollTimer;

    // JSON строка, которую показываем пользователю
    private string GeneratedJson = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Guid.TryParse(RequestId, out var id);

        await LoadStatus(id);

        PollTimer = new Timer(async _ =>
        {
            await LoadStatus(id);
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task LoadStatus(Guid id)
    {
        Status = await ApiClient.GetRequestStatus(id);

        if (Status?.Data.GeneratedData != null)
        {
            GeneratedJson = JsonSerializer.Serialize(
                Status.Data.GeneratedData,
                new JsonSerializerOptions { WriteIndented = true }
            );
        }

        IsLoading = Status is null || Status.Data.CurrentStatus != "Completed";
    }

    private Color ChipColor =>
        Status?.Data.CurrentStatus switch
        {
            "Completed" => Color.Success,
            "Canceled" => Color.Error,
            "PostData" => Color.Info,
            _ => Color.Default
        };
    /// <summary>
    /// Попытка изменения json
    /// </summary>
    /// <param name="newValue"></param>
    private async Task OnJsonEditAttempt(string newValue)
    {
        Snackbar.Add("Редактирование данных пока недоступно — функционал в разработке.", Severity.Info);

        // откат
        GeneratedJson = JsonSerializer.Serialize(
            Status!.Data.GeneratedData,
            new JsonSerializerOptions { WriteIndented = true }
        );

        await InvokeAsync(StateHasChanged);
    }
}
